<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat and Talk</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu&display=swap" />
    <link rel="stylesheet" type="text/css" href="layout.css" />
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  </head>



  <body>
    <h1 id="roomName">聊天室</h1>
    <div class="container-fluid">
      <div class="row">
        <div class="col-8 table-responsive">
          <table class="table-nowrap">
            <thead>
            </thead>
            <tbody id="Msg">
              
            </tbody>
          </table>
        </div>
        <div class="col-4">
          <h1 style="color:grey">圖片<h1>
          <div id="Image">
          </div>
        </div>
      </div>
    </div>
    <form>
      <input type="text" id="msg" placeholder="輸入訊息" style="border-color:black;border-width:3px;border-style:solid;" />
      <input type="submit" id="submitButton" value="Send" />
    </form>
  </body>


  <script src="/socket.io/socket.io.js"></script>
  <script
    src="https://code.jquery.com/jquery-3.5.1.js"
    integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
    crossorigin="anonymous"
  ></script>
  <script>
    let userName = prompt("Username");
    let roomName = prompt("Room name");
    let socket = io();
    
    document.getElementById("roomName").innerText = roomName

    // send event that user has joined room
    socket.emit("join", {userName: userName, roomName: roomName});

    // focus on text box
    document.getElementById("msg").focus();

    // submit
    document
      .getElementsByTagName("form")[0]
      .addEventListener("submit", function (event) {
        event.preventDefault();
        socket.emit("send message", {
          author: userName,
          room: roomName,
          message: document.getElementById("msg").value
        });

        document.getElementById("msg").value = "";
        document.getElementById("msg").focus();
      });

    // show get new message
    socket.on("show message", (data)=>{
      const tr = document.createElement("tr");
      const Atd = document.createElement("td");
      const Mtd = document.createElement("td");
      const Ttd = document.createElement("td");
      let authorClass = "";
      let divClass = "";

      // verify that who send the message
      if (data.author === userName) {
        divClass = "myMsg";
      } else {
        divClass = "otherMsg";
      }

      tr.className = divClass;
      Atd.className = "author";
      Mtd.className = "message";
      Ttd.className = "time";

      Atd.innerText = data.author;
      Mtd.innerText = data.message;
      Ttd.innerText = data.time;
      
      tr.appendChild(Atd);
      tr.appendChild(Mtd);
      tr.appendChild(Ttd);

      var first = document.getElementById("Msg").firstChild;
      document.getElementById("Msg").insertBefore(tr,first);
      
      // Show image
      if (data.image != null) {
        const img = document.createElement("img")
        img.src = data.image
        var fimg = document.getElementById("Image").firstChild;
        document.getElementById("Image").insertBefore(img,fimg)
      }
    });

    // remove message
    socket.on("hide message", (data)=>{
      document.getElementById(data.id).remove();
    });

    function checkURL(url) {
      return(url.match(/\.(jpeg|jpg|gif|png)$/) != null);
    }
  </script>
</html>